<!DOCTYPE html>
<html>

<head>
    <title>N00143888 - Aaron O'Hare</title>
    <meta charset="utf-8">
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script>
        
        function init(){
            addName();
            chat();
        }
        var myUser = prompt("Please enter a username");
        var socket = io.connect();
        //display the client ID on the webpage
        socket.on('connect', function () {
            document.getElementById("clientId").innerHTML = "This client's ID is " + socket.id;
        });
        socket.on('clientList', function(data){
            console.log(data);
            var otherUsers = data.length - 1;
            document.getElementById("noUsers").innerHTML = "Welcome " + myUser + ". There are " + otherUsers + " other users connected.";
        });
        //Currently not fully implemented - recieevs random colour hex from server
        socket.on('colour', function(data){
            console.log("Colour:" + data);
        })
      
        function addName(){
            console.log(myUser);
            socket.emit('new name', myUser)

        }
        socket.on('usernames', function(data){
            console.log("TESTING:" + data);
            for(i = 0; i<data.length; i++){
                var usersString = "All Users";
                usersString += data[i];
                console.log(i);
            }
            document.getElementById("allUsers").innerHTML ="All Users: " + data;
        })
        function chat() {
            if (Notification.permission !== "granted") Notification.requestPermission();
            document.getElementById("chatForm").onsubmit = function getMessage() {
                var time = new Date();
                var curTime = time.getHours() + ":" + time.getMinutes() + ":" + time.getSeconds() + ": "
                socket.emit('chat message', myUser + ": " + document.getElementById('chatbox').value+ " - " + curTime);
                event.preventDefault();
            };
            socket.on('chat message', function (message) {
                var listItem = document.createElement("li");
                var listItemText = document.createTextNode(message);
                listItem.appendChild(listItemText);
                document.getElementById('messages').appendChild(listItem);
                document.getElementById('chatbox').value = ("");
                notify()
            });
        };

        function notify() {

            if (!Notification) {
                alert('Desktop notifications are not supported - please use Chrome or FireFox.');
            }
            if (Notification.permission !== "granted") Notification.requestPermission();
            if (!document.hasFocus()) {
                var notification = new Notification('WebChat', {
                    icon: 'http://www.myiconfinder.com/uploads/iconsets/256-256-f269bbc2a3bd8805b0dccb6c36dd2fac.png'
                    , body: "You have a new message"
                , });
           
            notification.onclick = function (event) {
                window.focus();
            }
             }
        }
    </script>
</head>

<body onload="init()">
    <p id="clientId"></p>
    <p id="noUsers"></p>
    <p id="allUsers"></p>
    <div id="chat">
        <ul id="messages"></ul>
        <form id="chatForm" autocomplete='off'>
            <input id="chatbox" placeholder="Type Message Here, Press Enter To Send" /> </form>
    </div>
</body>

</html>